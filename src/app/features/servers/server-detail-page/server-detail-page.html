<!-- Header Template for Page Header Service -->
<ng-template #serverHeaderTemplate let-component>
  <header class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between px-6 py-4 h-[120px]" (click)="component.closeActionsDropdown()">
    <div class="flex items-start gap-4">
      @if (component.server() && !component.loading()) {
        <!-- Server Type/ID -->
        <div class="text-center">
          <div class="text-3xl font-bold text-ink">{{ component.server()!.server_type?.name?.toUpperCase() || 'UNKNOWN' }}</div>
          <div class="text-sm text-soft">#{{ component.server()!.id.toString().slice(-8) }}</div>
        </div>
        
        <!-- Separator Line -->
        <div class="border-l-2 border-ui h-16 self-start mt-1"></div>
        
        <!-- Server Name and IPs -->
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="status-dot" [ngClass]="component.server()!.status"></span>
            <h1 class="text-2xl font-bold text-ink">{{ component.server()!.name }}</h1>
          </div>
          @if (component.hasPublicIPs(component.server()!)) {
            <div class="flex items-center gap-4 mt-2">
              @if (component.getIPv4(component.server()!)) {
                <div class="flex items-center gap-2">
                  <span class="text-xs text-soft">IPv4:</span>
                  <code class="px-2 py-1 text-xs bg-muted rounded text-ink font-mono">{{ component.getIPv4(component.server()!) }}</code>
                </div>
              }
              @if (component.getIPv6(component.server()!)) {
                <div class="flex items-center gap-2">
                  <span class="text-xs text-soft">IPv6:</span>
                  <code class="px-2 py-1 text-xs bg-muted rounded text-ink font-mono">{{ component.getIPv6(component.server()!) }}</code>
                </div>
              }
            </div>
          }
        </div>
      } @else {
        <div class="flex-1">
          <h1 class="text-xl font-semibold text-ink">Server Details</h1>
        </div>
      }
    </div>
    
    @if (component.server() && !component.loading()) {
      <div class="flex items-center gap-3">
        <!-- Actions Dropdown -->
        <div class="relative">
          <button 
            (click)="$event.stopPropagation(); component.toggleActionsDropdown()"
            class="action-btn action-btn-secondary flex items-center gap-2">
            Actions
            <span class="text-xs">{{ component.showActionsDropdown() ? '‚ñ≤' : '‚ñº' }}</span>
          </button>
          
          @if (component.showActionsDropdown()) {
            <div 
              class="actions-dropdown absolute right-0 top-full mt-2 w-48 rounded-lg z-50"
              (click)="$event.stopPropagation()">
              <div class="py-2">
                @if (component.server()!.status === 'running') {
                  <button 
                    (click)="component.turnOffServer()"
                    class="w-full px-4 py-2 text-left text-sm transition-colors">
                    Turn Off
                  </button>
                  <button 
                    (click)="component.shutDownServer()"
                    class="w-full px-4 py-2 text-left text-sm transition-colors">
                    Shut Down
                  </button>
                }
                @if (component.server()!.status === 'stopped') {
                  <div class="px-4 py-2 text-sm text-soft">
                    Server is stopped
                  </div>
                }
                <hr class="my-2 border-ui">
                <button 
                  (click)="component.deleteServerFromDropdown()"
                  class="delete-action w-full px-4 py-2 text-left text-sm transition-colors">
                  Delete
                </button>
              </div>
            </div>
          }
        </div>
        
        <!-- Power Toggle Switch with Label -->
        <div class="flex items-center gap-3">
          <label class="power-switch">
            <input 
              type="checkbox" 
              [checked]="component.server()!.status === 'running'"
              (change)="component.togglePower()"
              [disabled]="false">
            <span class="power-slider">
              <span class="power-label-off">OFF</span>
              <span class="power-label-on">ON</span>
            </span>
          </label>
        </div>
      </div>
    }
  </header>
</ng-template>

<section class="space-y-6" (click)="closeActionsDropdown()">

  <!-- Loading State -->
  @if (loading()) {
    <div class="server-detail-card">
      <div class="space-y-4">
        <div class="skeleton h-6 w-48"></div>
        <div class="skeleton h-4 w-32"></div>
        <div class="skeleton h-4 w-24"></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
          <div class="skeleton h-20 w-full"></div>
          <div class="skeleton h-20 w-full"></div>
          <div class="skeleton h-20 w-full"></div>
        </div>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <div class="server-detail-card">
      <div class="text-center py-8">
        <div class="text-red-500 text-lg mb-2">‚ö†Ô∏è Error</div>
        <p class="text-soft">{{ error() }}</p>
        <button 
          (click)="goBack()"
          class="mt-4 px-4 py-2 rounded-lg text-white bg-primary hover:bg-primary-700 transition-colors">
          Return to Servers
        </button>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (loading() || api.loading()) {
    <div class="server-detail-card">
      <div class="text-center py-8">
        <div class="text-soft text-lg mb-2">‚è≥ Loading Server Details...</div>
        <p class="text-soft">Please wait while we fetch your server information.</p>
      </div>
    </div>
  }

  <!-- Server Not Found -->
  @else if (!server() && !loading() && !error() && !api.loading()) {
    <div class="server-detail-card">
      <div class="text-center py-8">
        <div class="text-soft text-lg mb-2">üîç Server Not Found</div>
        <p class="text-soft">The requested server could not be found.</p>
        <button 
          (click)="goBack()"
          class="mt-4 px-4 py-2 rounded-lg text-white bg-primary hover:bg-primary-700 transition-colors">
          Return to Servers
        </button>
      </div>
    </div>
  }

  <!-- Server Details -->
  @if (server() && !loading()) {
    <div class="space-y-6">
      <!-- Consolidated Server Metrics Card -->
      <div class="server-detail-card">
        <div class="flex flex-wrap gap-4">
          <!-- vCPU -->
          <div class="metric-item">
            <div class="metric-content">
              <div class="metric-icon">üñ•Ô∏è</div>
              <div class="metric-text">
                <div class="metric-value">{{ getCpuCount(server()!) }}</div>
                <div class="metric-label">vCPU</div>
              </div>
            </div>
          </div>
          
          <!-- RAM -->
          <div class="metric-item">
            <div class="metric-content">
              <div class="metric-icon">üíæ</div>
              <div class="metric-text">
                <div class="metric-value">{{ getRamSize(server()!) }}</div>
                <div class="metric-label">RAM</div>
              </div>
            </div>
          </div>
          
          <!-- Disk -->
          <div class="metric-item">
            <div class="metric-content">
              <div class="metric-icon">üíΩ</div>
              <div class="metric-text">
                <div class="metric-value">{{ getDiskSize(server()!) }}</div>
                <div class="metric-label">DISK LOCAL</div>
              </div>
            </div>
          </div>
          
          <!-- Usage -->
          <div class="metric-item">
            <div class="metric-content">
              <div class="metric-icon">‚Ç¨</div>
              <div class="metric-text">
                <div class="metric-value">{{ calculateCurrentUsage(server()!) }}</div>
                <div class="metric-label">USAGE</div>
              </div>
            </div>
          </div>
          
          <!-- Traffic In -->
          <div class="metric-item">
            <div class="metric-content">
              <div class="metric-icon">‚Üì</div>
              <div class="metric-text">
                <div class="metric-value">{{ getIncomingTrafficDisplay(server()!) }}</div>
                <div class="metric-label">TRAFFIC IN</div>
              </div>
            </div>
          </div>
          
          <!-- Traffic Out -->
          <div class="metric-item">
            <div class="metric-content">
              <div class="metric-icon">‚Üë</div>
              <div class="metric-text">
                <div class="metric-value">{{ getOutgoingTrafficDisplay(server()!) }}</div>
                <div class="metric-label">TRAFFIC OUT</div>
              </div>
            </div>
          </div>
          
          <!-- Price -->
          <div class="metric-item">
            <div class="metric-content">
              <div class="metric-icon">‚Ç¨</div>
              <div class="metric-text">
                <div class="metric-value">{{ getServerPrice(server()!).toFixed(2) }}<span class="text-xs">/MO</span></div>
                <div class="metric-label">PRICE</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Sections (Two Column Layout) -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Left Column: Server Activities (Full Height) -->
        <div class="lg:col-span-1">
          <div class="server-detail-card h-full">
            <h3 class="text-lg font-semibold text-ink mb-4 flex items-center gap-2">
              üîî Server Activities
            </h3>
            <div class="space-y-3">
              @for (activity of activities(); track activity.id) {
                <div class="activity-item">
                  <div class="activity-left">
                    <div class="flex items-center gap-3">
                      <span class="activity-category-dot" [ngClass]="getActivityCategoryClasses(activity.category)"></span>
                      <div>
                        <div class="activity-title flex items-center gap-2">
                          <span>{{ activity.icon }}</span>
                          <span>{{ activity.title }}</span>
                          <span [ngClass]="getActivityStatusClasses(activity.status)">{{ activity.status }}</span>
                        </div>
                        @if (activity.description) {
                          <div class="activity-description text-xs text-soft mt-1">{{ activity.description }}</div>
                        }
                      </div>
                    </div>
                  </div>
                  <div class="activity-time">{{ getActivityRelativeTime(activity.timestamp) }}</div>
                </div>
              }
              
              @if (activities().length === 0) {
                <div class="text-center py-6 text-soft">
                  <div class="text-lg mb-2">üì≠</div>
                  <div>No recent activities</div>
                  <div class="text-xs mt-1">Server activities will appear here</div>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Right Column: Server Options + Location (Full Height Split) -->
        <div class="lg:col-span-1 flex flex-col gap-6">
          
          <!-- Server Options (Half Height) -->
          <div class="server-detail-card flex-1 flex flex-col">
            <h3 class="text-lg font-semibold text-ink mb-4 flex items-center gap-2">
              ‚öôÔ∏è Server Options
            </h3>
            <div class="flex-1 flex items-center">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full">
                <div class="option-button-wrapper">
                  <div class="option-icon">üíæ</div>
                  <div class="option-button-content">
                    <button 
                      class="px-4 py-2 rounded-lg transition-colors font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-900/50"
                      (click)="openNetworkDialog()">
                      <span>Info</span>
                    </button>
                    <div class="option-label">BACKUP</div>
                  </div>
                </div>
                
                <div class="option-button-wrapper">
                  <div class="option-icon">üì¶</div>
                  <div class="option-button-content">
                    <button 
                      class="px-4 py-2 rounded-lg transition-colors font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-900/50"
                      (click)="openNetworkDialog()">
                      <span>Info</span>
                    </button>
                    <div class="option-label">PLACEMENT GROUP</div>
                  </div>
                </div>
                
                <div class="option-button-wrapper">
                  <div class="option-icon">üåê</div>
                  <div class="option-button-content">
                    <button 
                      class="px-4 py-2 rounded-lg transition-colors font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-900/50"
                      (click)="openNetworkDialog()">
                      <span>Info</span>
                    </button>
                    <div class="option-label">PUBLIC NETWORK</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Server Location (Half Height) -->
          <div class="server-detail-card flex-1 flex flex-col">
            <h3 class="text-lg font-semibold text-ink mb-4 flex items-center gap-2">
              üìç Server Location
            </h3>
            <div class="flex-1 flex flex-col">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1">
                <!-- Left: Location Details -->
                <div class="location-details flex flex-col justify-center">
                  <div class="grid grid-cols-2 gap-4">
                    <!-- Column 1: DATACENTER & COUNTRY -->
                    <div class="location-item">
                      <div class="location-details">
                        <div class="location-label">DATACENTER</div>
                        <div class="location-value">{{ server()!.datacenter.name || server()!.datacenter.location.name || server()!.location }}</div>
                      </div>
                      <div class="location-details mt-4">
                        <div class="location-label">COUNTRY</div>
                        <div class="location-value">
                          {{ getCountryFlag(server()!) }} {{ server()!.datacenter.location.country || server()!.country }}
                        </div>
                      </div>
                    </div>
                    
                    <!-- Column 2: CITY & NETWORK ZONE -->
                    <div class="space-y-4">
                      <div class="location-item">
                        <div class="location-label">CITY</div>
                        <div class="location-value">{{ getCleanCityName(server()!) }}</div>
                      </div>
                      <div class="location-item">
                        <div class="location-label">NETWORK ZONE</div>
                        <div class="location-value">{{ getNetworkZone() }}</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Right: Location Map (Full Height) -->
                <div class="location-map flex flex-col justify-center">
                  <div class="h-full min-h-[180px]">
                    <app-location-map 
                      [countryCode]="server()!.datacenter.location.country || server()!.country || ''"
                      [locationName]="getCleanCityName(server()!)"
                      class="block w-full h-full">
                    </app-location-map>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</section>

<!-- Delete Confirmation Dialog -->
@if (showDeleteDialog()) {
  <app-delete-confirmation-dialog
    [serverName]="server()?.name || ''"
    (confirm)="confirmDelete()"
    (cancel)="cancelDelete()">
  </app-delete-confirmation-dialog>
}

<!-- Network Details Dialog -->
@if (showNetworkDialog()) {
  <app-network-details-dialog
    [server]="server()!"
    (cancel)="closeNetworkDialog()">
  </app-network-details-dialog>
}