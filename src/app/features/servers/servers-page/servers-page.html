<section class="space-y-4">
  <!-- Toolbar -->
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <h1 class="text-xl font-semibold text-ink">Server List</h1>

    <div class="flex flex-wrap gap-2 items-center">
      <span class="text-sm text-soft">Available server configurations</span>

      <button 
        class="px-4 py-2 rounded-lg transition-colors"
        [class]="hasSelection() ? 'text-white bg-primary hover:bg-primary-700' : 'text-gray-400 bg-gray-200 cursor-not-allowed'"
        [disabled]="!hasSelection()"
        (click)="createSelectedServer()">
        Create Server
      </button>
    </div>
  </header>

  <!-- SKELETON (Table with card rows) -->
  @if (loading()) {
    <div class="hidden md:block space-y-4">
      <!-- Skeleton Header -->
      <div class="bg-[color-mix(in_oklab,_var(--surface)_92%,_black)] rounded-lg border border-ui/30 px-4 py-3">
        <div class="grid grid-cols-[2fr_1fr_0.5fr_0.5fr_0.5fr_1fr_1fr_1fr] gap-4">
          <div class="skeleton h-4 w-12"></div>
          <div class="skeleton h-4 w-10"></div>
          <div class="skeleton h-4 w-8"></div>
          <div class="skeleton h-4 w-8"></div>
          <div class="skeleton h-4 w-8"></div>
          <div class="skeleton h-4 w-16"></div>
          <div class="skeleton h-4 w-12"></div>
          <div class="skeleton h-4 w-12"></div>
        </div>
      </div>

      <!-- Skeleton Rows -->
      <div class="space-y-3">
        @for (_ of skeletonRows; track $index) {
          <div class="server-card">
            <div class="grid grid-cols-[2fr_1fr_0.5fr_0.5fr_0.5fr_1fr_1fr_1fr] gap-4 items-center">
              <div class="skeleton h-5 w-3/4"></div>
              <div class="skeleton h-5 w-1/2"></div>
              <div class="skeleton h-5 w-full"></div>
              <div class="skeleton h-5 w-full"></div>
              <div class="skeleton h-5 w-full"></div>
              <div class="skeleton h-5 w-2/3"></div>
              <div class="skeleton h-5 w-1/2"></div>
              <div class="skeleton h-5 w-1/2"></div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Mobile Skeleton -->
    <div class="md:hidden space-y-3">
      @for (_ of skeletonRows; track $index) {
        <div class="server-card">
          <div class="flex items-center justify-between mb-2">
            <div class="skeleton h-5 w-32"></div>
            <div class="skeleton h-3 w-3 rounded-full"></div>
          </div>
          <div class="skeleton h-4 w-full"></div>
          <div class="skeleton h-3 w-3/4 mt-1"></div>
        </div>
      }
    </div>
  }

  <!-- ERROR STATE -->
  @if (!loading() && error()) {
    <div class="text-center py-12">
      <div class="text-red-500 text-4xl mb-4">⚠️</div>
      <h2 class="text-lg font-medium text-ink mb-2">Failed to load servers</h2>
      <p class="text-soft mb-4">{{ error() }}</p>
      <button 
        class="px-4 py-2 rounded-lg text-white bg-primary hover:bg-primary-700 transition-colors"
        (click)="retry()">
        Retry
      </button>
    </div>
  }

  <!-- EMPTY STATE -->
  @if (!loading() && !error() && view().length === 0) {
    <div class="text-center py-12">
      <div class="text-4xl mb-4">�</div>
      <h2 class="text-lg font-medium text-ink mb-2">No server types available</h2>
      <p class="text-soft mb-6">
        @if (isUsingMockData) {
          Mock data is not available or the file could not be loaded.
        } @else {
          Could not load available server configurations from Hetzner Cloud API.
        }
      </p>
      <div class="flex flex-col sm:flex-row gap-3 justify-center">
        <button 
          class="px-4 py-2 rounded-lg text-white bg-primary hover:bg-primary-700 transition-colors"
          (click)="retry()">
          Retry
        </button>
        @if (!isUsingMockData) {
          <a 
            href="https://console.hetzner.cloud/" 
            target="_blank"
            class="px-4 py-2 rounded-lg border border-slate-300 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">
            Open Hetzner Console
          </a>
        }
      </div>
    </div>
  }

  <!-- TABLE WITH CARD ROWS (md+) -->
  @if (!loading() && !error() && view().length > 0) {
    <div class="hidden md:block space-y-4">
      <!-- Table Header -->
      <div class="px-4 py-3">
        <div class="grid grid-cols-[auto_2fr_1fr_0.5fr_0.5fr_0.5fr_1fr_1fr_1fr] gap-4 text-sm text-soft font-bold">
          <span></span> <!-- Empty space for checkbox column -->
          <button 
            class="sortable-header text-left"
            [class.sorted]="isColumnSorted('name')"
            (click)="onSort('name')"
            [attr.aria-label]="'Sort by name ' + (sortColumn() === 'name' ? sortDirection() : 'none')"
            type="button">
            <span>Name</span>
            <span class="sort-arrow" aria-hidden="true">
              <span class="sort-arrow-up" [style.display]="showUpArrow('name') ? 'block' : 'none'">▲</span>
              <span class="sort-arrow-down" [style.display]="showDownArrow('name') ? 'block' : 'none'">▼</span>
            </span>
          </button>
          <button 
            class="sortable-header text-left"
            [class.sorted]="isColumnSorted('type')"
            (click)="onSort('type')"
            [attr.aria-label]="'Sort by type ' + (sortColumn() === 'type' ? sortDirection() : 'none')"
            type="button">
            <span>Type</span>
            <span class="sort-arrow" aria-hidden="true">
              <span class="sort-arrow-up" [style.display]="showUpArrow('type') ? 'block' : 'none'">▲</span>
              <span class="sort-arrow-down" [style.display]="showDownArrow('type') ? 'block' : 'none'">▼</span>
            </span>
          </button>
          <button 
            class="sortable-header text-left text-xs"
            [class.sorted]="isColumnSorted('vcpus')"
            (click)="onSort('vcpus')"
            [attr.aria-label]="'Sort by vCPUs ' + (sortColumn() === 'vcpus' ? sortDirection() : 'none')"
            type="button">
            <span>vCPUs</span>
            <span class="sort-arrow" aria-hidden="true">
              <span class="sort-arrow-up" [style.display]="showUpArrow('vcpus') ? 'block' : 'none'">▲</span>
              <span class="sort-arrow-down" [style.display]="showDownArrow('vcpus') ? 'block' : 'none'">▼</span>
            </span>
          </button>
          <button 
            class="sortable-header text-left text-xs"
            [class.sorted]="isColumnSorted('ram')"
            (click)="onSort('ram')"
            [attr.aria-label]="'Sort by RAM ' + (sortColumn() === 'ram' ? sortDirection() : 'none')"
            type="button">
            <span>RAM</span>
            <span class="sort-arrow" aria-hidden="true">
              <span class="sort-arrow-up" [style.display]="showUpArrow('ram') ? 'block' : 'none'">▲</span>
              <span class="sort-arrow-down" [style.display]="showDownArrow('ram') ? 'block' : 'none'">▼</span>
            </span>
          </button>
          <button 
            class="sortable-header text-left text-xs"
            [class.sorted]="isColumnSorted('ssd')"
            (click)="onSort('ssd')"
            [attr.aria-label]="'Sort by SSD storage ' + (sortColumn() === 'ssd' ? sortDirection() : 'none')"
            type="button">
            <span>SSD</span>
            <span class="sort-arrow" aria-hidden="true">
              <span class="sort-arrow-up" [style.display]="showUpArrow('ssd') ? 'block' : 'none'">▲</span>
              <span class="sort-arrow-down" [style.display]="showDownArrow('ssd') ? 'block' : 'none'">▼</span>
            </span>
          </button>
          <button 
            class="sortable-header text-left"
            [class.sorted]="isColumnSorted('location')"
            (click)="onSort('location')"
            [attr.aria-label]="'Sort by location ' + (sortColumn() === 'location' ? sortDirection() : 'none')"
            type="button">
            <span>Location</span>
            <span class="sort-arrow" aria-hidden="true">
              <span class="sort-arrow-up" [style.display]="showUpArrow('location') ? 'block' : 'none'">▲</span>
              <span class="sort-arrow-down" [style.display]="showDownArrow('location') ? 'block' : 'none'">▼</span>
            </span>
          </button>
          <button 
            class="sortable-header text-left"
            [class.sorted]="isColumnSorted('status')"
            (click)="onSort('status')"
            [attr.aria-label]="'Sort by status ' + (sortColumn() === 'status' ? sortDirection() : 'none')"
            type="button">
            <span>Status</span>
            <span class="sort-arrow" aria-hidden="true">
              <span class="sort-arrow-up" [style.display]="showUpArrow('status') ? 'block' : 'none'">▲</span>
              <span class="sort-arrow-down" [style.display]="showDownArrow('status') ? 'block' : 'none'">▼</span>
            </span>
          </button>
          <button 
            class="sortable-header text-right"
            [class.sorted]="isColumnSorted('price')"
            (click)="onSort('price')"
            [attr.aria-label]="'Sort by price ' + (sortColumn() === 'price' ? sortDirection() : 'none')"
            type="button">
            <span>Price</span>
            <span class="sort-arrow" aria-hidden="true">
              <span class="sort-arrow-up" [style.display]="showUpArrow('price') ? 'block' : 'none'">▲</span>
              <span class="sort-arrow-down" [style.display]="showDownArrow('price') ? 'block' : 'none'">▼</span>
            </span>
          </button>
        </div>
      </div>

      <!-- Table Rows as Cards -->
      <div class="space-y-3">
        @for (s of view(); track trackRow($index, s)) {
          <div class="server-card cursor-pointer" (click)="selectServer(s)" [class.selected]="isSelected(s)">
            <div class="grid grid-cols-[auto_2fr_1fr_0.5fr_0.5fr_0.5fr_1fr_1fr_1fr] gap-4 items-center text-sm">
              <div class="flex items-center">
                <input 
                  type="radio" 
                  [checked]="isSelected(s)"
                  (click)="$event.stopPropagation(); selectServer(s)"
                  class="w-4 h-4 text-primary bg-gray-100 border-gray-300 focus:ring-primary-500 focus:ring-2">
              </div>
              <div class="font-medium text-primary">{{ s.name }}</div>
              <div class="text-soft">{{ s.type }}</div>
              <div class="text-soft text-xs">{{ getCpuCount(s) }}</div>
              <div class="text-soft text-xs">{{ getRamSize(s) }}</div>
              <div class="text-soft text-xs">{{ getDiskSize(s) }}</div>
              <div class="text-soft">
                @if (hasCountryData(s)) {
                  <span class="inline-flex items-center gap-2">
                    <span class="text-base">{{ getCountryFlag(s) }}</span>
                    <span>{{ getCleanCityName(s) }}</span>
                  </span>
                } @else {
                  <span>{{ getCleanCityName(s) }}</span>
                }
              </div>
              <div>
                <span class="inline-flex items-center gap-2">
                  <span class="status-dot" [ngClass]="s.status"></span>
                  <span class="capitalize">{{ s.status }}</span>
                </span>
              </div>
              <div class="text-right text-soft">
                €{{ (s.priceEur || 0).toFixed(2) }}/mo
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- MOBILE CARDS (sm) -->
  @if (!loading() && !error() && view().length > 0) {
    <div class="md:hidden space-y-3">
      @for (s of view(); track trackRow($index, s)) {
        <div class="server-card" (click)="selectServer(s)" [class.selected]="isSelected(s)">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <input 
                type="radio" 
                [checked]="isSelected(s)"
                (click)="$event.stopPropagation(); selectServer(s)"
                class="w-4 h-4 text-primary bg-gray-100 border-gray-300 focus:ring-primary-500 focus:ring-2">
              <div class="name">{{ s.name }}</div>
            </div>
            <div class="status-dot" [ngClass]="s.status"></div>
          </div>
          <div class="meta">
            @if (hasCountryData(s)) {
              {{ s.type }} • {{ getCountryFlag(s) }} {{ getCleanCityName(s) }} • €{{ (s.priceEur || 0).toFixed(2) }}/mo
            } @else {
              {{ s.type }} • {{ getCleanCityName(s) }} • €{{ (s.priceEur || 0).toFixed(2) }}/mo
            }
          </div>
          <div class="hardware text-xs text-soft mt-1">
            {{ getHardwareSpecs(s) }}
          </div>
        </div>
      }
    </div>
  }
</section>

<!-- Server Name Dialog -->
@if (showNameDialog() && getSelectedServer()) {
  <app-server-name-dialog
    [selectedServer]="getSelectedServer()!"
    (confirm)="onServerNameConfirmed($event)"
    (cancel)="onServerNameCancelled()">
  </app-server-name-dialog>
}
